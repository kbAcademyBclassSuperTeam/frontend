{% extends "base.html" %}

{% block content %}


<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <title>Home!</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script>
    // tts 시작
    var voices = [];

    function setVoiceList() {
        voices = window.speechSynthesis.getVoices();
    }

    if (window.speechSynthesis.onvoiceschanged !== undefined) {
        window.speechSynthesis.onvoiceschanged = setVoiceList;

    }

    function speech(txt) {
      
        if(!window.speechSynthesis) {
            alert("음성 재생을 지원하지 않는 브라우저입니다. 크롬, 파이어폭스 등의 최신 브라우저를 이용하세요");
        return;
        }

    var lang = 'ko-KR';
    var utterThis = new SpeechSynthesisUtterance(txt);
    
    utterThis.onend = function (event) {
        console.log('end');
    };
    utterThis.onerror = function(event) {
        console.log('error', event);
    };

    var voiceFound = false;
    for(var i = 0; i < voices.length ; i++) { // 20
        if(voices[i].lang.indexOf(lang) >= 0 || voices[i].lang.indexOf(lang.replace('-', '_')) >= 0) {
            utterThis.voice = voices[i];
            voiceFound = true;
        }
    }

    if(!voiceFound) {
        alert('voice not found');
        return;
    }
    
    utterThis.lang = lang;
    utterThis.pitch = 1;
    utterThis.rate = 1; //속도

    window.speechSynthesis.speak(utterThis);

    }

    window.addEventListener("load", function(e) {
      setTimeout(() => {
      var t = e.target;
      var input = t.previousElementSibling;
      var speacklist=[
      "좋은 하루입니다! AI 행원 루나스입니다.",
        "무엇을 도와드릴까요?",
        "입금, 출금, 송금, 계좌조회, 계좌개설, 카드발급이 가능합니다.",
        ];

      for(var j=0;j<1;j++) {
          console.log(speacklist[j]);
          speech(speacklist[j]);
      }
      return;
    }, 1000);
    });

    // tts 끝
      function search(texts) {
          let search_key = texts
          let search_var = ''
          $.ajax({ 
              type: "GET", 
              url:'search/', 
              data : { 'search_key':search_key}, 
              dataType: 'json',
              async:false,
              success:function(data){ 
                  search_var = data['search_key']
              } ,
              error: function (error) {
                  // console.log(error);
                search_var = '0'
            }
          }) 	
          return search_var
      } 
  
      function promise_search(texts){
          return new Promise((resolve, reject) => {
              let target = search(texts)
              // 0.4초 안에 통신이 안되면, 에러 발생( promise 객체 이용 )
              setTimeout(() => {
                  if (target != undefined){
                      resolve(target)
                  } else {
                      reject('서버에 문제가 발생하여 인식하지 못했습니다.\n 다시 시도해주세요.')
                  }
              }, 400)
          })
      }

      function make_body(target_num, texts){
        
        const objBody = document.querySelector(".body"); 
        
        function addChat(sentence) {
          chatBody.innerHTML += '<div class="receive">' + sentence + '</div>'
          objBody.scrollTop = objBody.scrollHeight;
          speech(sentence);
        }
        
        function addChatNoTts(sentence) {
          chatBody.innerHTML += '<div class="receive">' + sentence + '</div>'
          objBody.scrollTop = objBody.scrollHeight;
          
        }
        function printAndTTS(senlist) {
          var delaySec = 3000;
          for(let j =0; j<senlist.length ; j++) {
            var anonFunc = function(j) {
              setTimeout(() => {
                if(senlist[j]=="...") addChatNoTts(senlist[j]);
                else if (senlist[j]!="") addChat(senlist[j]);
                else window.location.href = '/main/';   
              }, j*delaySec)
            }
            anonFunc(j);
          }
        }
        if(texts == 'button'){
          console.log(target_num)
          printAndTTS(search(target_num))

          return
        }

        // 타겟 넘버 별 TTS 시작 부분  
        if (texts == "안녕하세요"){
          addChat(target_num)
        }else{
          printAndTTS(target_num)
        }
        // TTS end
        
      }
  </script>

</head>
<body>
<div class="main-frame row">
    <div class="ai-screen col-4">
        <div class="ai-screen-title d-flex">
            <p class="m-0">AI 일반 행원 김범수</p>
        </div>
        <div class="ai-screen-main">
        </div>
    </div>
    <div class="chatbot-screen col-8 d-flex justify-content-center align-items-center">
      <div class="container">
        <div class="body">
          <div class="receive">
            <div class="word">
            "좋은 하루입니다! AI 행원 루나스입니다.” <br><br>
            “무엇을 도와드릴까요?”
            </div>
            <div class="quick-container">
              <div><빠른 업무></div>
              <button class="quick_btn" id="btn_2" value="2">1. 입금</button>
              <button class="quick_btn" id="btn_6" value="6">2. 출금</button>
              <button class="quick_btn" id="btn_1" value="1">3. 송금</button>
              <button class="quick_btn" id="btn_3" value="3">4. 계좌조회</button>
              <button class="quick_btn" id="btn_4" value="4">5. 계좌개설</button>
              <button class="quick_btn" id="btn_5" value="5">6. 카드발급</button>
              <button class="quick_btn" id="btn_7" value="7">7. 상품소개</button>
            </div>
            <div class="padding"></div>
          </div>
          {% comment %} <div class="receive">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loadTerms">모달</button>
          </div> {% endcomment %}
        </div>
        <div class="input_bar">
          <form class="form">
            <input type="text" class="form_input">
            <button class="btn">전송</button>
          </form>
        </div>
      </div>
    </div>
    <div class="modal fade" id="loadTerms" tabindex="-1" aria-labelledby="loadTermsLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="loadTerms">Modal title</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Lorem ipsum, dolor sit amet consectetur adipisicing elit. Rem minima qui possimus? Maiores neque rerum esse aperiam, temporibus labore voluptas ipsum voluptatum fuga quaerat aliquam assumenda vero deleniti quas! Velit!
            Harum inventore quidem nam excepturi odio provident sit placeat, voluptate aliquam mollitia fuga eveniet magni soluta eum, voluptates ullam voluptatum odit? Laborum dolor quo delectus exercitationem magni fugiat esse nam?
            Iusto sunt eos accusamus obcaecati totam ipsa rerum eaque quos, cumque voluptatibus! Odit possimus fugit ipsa quod earum enim adipisci optio doloribus nostrum saepe! Velit maxime alias placeat architecto. Ut.
            Reiciendis magnam praesentium aliquam inventore repellat facere at eveniet assumenda dolorem, dolore, necessitatibus nesciunt enim labore. Perspiciatis labore hic deleniti placeat quidem voluptatibus. Assumenda labore similique et, voluptatem dolorem perferendis.
            Nemo voluptatum blanditiis dolores, molestiae possimus accusamus. Illum, dolorem ab. Mollitia iusto ab voluptate incidunt praesentium, tenetur, ducimus magni temporibus cupiditate ex deserunt nobis ratione veniam id accusamus explicabo eligendi.
            Voluptatum unde aliquid sint tempora provident perferendis iusto ad quia consequatur ex? Quaerat corrupti tenetur dolorum ut deleniti dignissimos quos, exercitationem recusandae voluptates blanditiis quia magni in tempora distinctio! Quas!
            Explicabo est mollitia illo laboriosam neque. Nisi suscipit maxime quaerat dignissimos sequi blanditiis maiores molestias incidunt dolorum obcaecati, explicabo itaque inventore fuga, consequatur consequuntur beatae aspernatur, voluptatem officia numquam ex.
            Maiores totam dicta vero odio rerum? Perspiciatis saepe fugiat consectetur exercitationem repudiandae quos minus? Tempora exercitationem omnis saepe, incidunt quod temporibus animi pariatur nostrum iusto, asperiores reiciendis iure dignissimos ratione.
            Suscipit eum alias aspernatur ipsam, in magnam praesentium est fugiat nam sunt odit quia. Id iste, corporis labore cupiditate fugit dolore nulla blanditiis, laborum totam explicabo magni commodi aliquid quas.
            Rerum ipsum ullam quis id quidem sequi reiciendis aut nisi asperiores recusandae debitis, ipsa molestias neque, aspernatur, vero esse nesciunt aperiam nemo harum amet. Debitis eligendi doloremque modi adipisci nesciunt?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Save changes</button>
          </div>
        </div>
      </div>
    </div>
</div>

<script>

  document.body.style.overflow = "hidden"

  const chatForm = document.querySelector(".form");
  const chatInput = document.querySelector(".form_input");
  const chatBody = document.querySelector(".body");
  const btn1 = document.querySelector("#btn_1");
  const btn2 = document.querySelector("#btn_2");
  const btn3 = document.querySelector("#btn_3");
  const btn4 = document.querySelector("#btn_4");
  const btn5 = document.querySelector("#btn_5");
  const btn6 = document.querySelector("#btn_6");
  const btn7 = document.querySelector("#btn_7");

  function handleQuickBtn(event) {
    list = {
      "1" : "송금을 선택하셨습니다.",
      "2" : "입금을 선택하셨습니다.",
      "3" : "계좌조회을 선택하셨습니다.",
      "4" : "계좌개설을 선택하셨습니다.",
      "5" : "카드발급을 선택하셨습니다.",
      "6" : "출금을 선택하셨습니다.",
      "7" : "상품소개을 선택하셨습니다.",
    }

    const objBody = document.querySelector(".body");
    const target = event.target.value
    console.log(target + "이거뭐야")
    const list_num = list[target]
    console.log(list_num + "이거뭐야2")

    chatBody.innerHTML += "<div class='send'>" + list_num + "</div>"
    objBody.scrollTop = objBody.scrollHeight;
    make_body(list_num, 'button');
  }

  function handleChatSubmit(event) {

    const objBody = document.querySelector(".body");
    event.preventDefault();
    if (chatInput.value == "")
      return;
    const inputValue = chatInput.value;

    chatBody.innerHTML += "<div class='send'>" + inputValue + "</div>"
    chatInput.value = "";

    objBody.scrollTop = objBody.scrollHeight;
    let target = promise_search(inputValue)
          .then()
          .catch((error) => {
              console.log(error)
          })

      async function logItems(target) {
        var target_num = await target;
        make_body(target_num, inputValue)
      }    
      logItems(target)
  }



  chatForm.addEventListener("submit", handleChatSubmit);
  btn1.addEventListener("click", handleQuickBtn);
  btn2.addEventListener("click", handleQuickBtn);
  btn3.addEventListener("click", handleQuickBtn);
  btn4.addEventListener("click", handleQuickBtn);
  btn5.addEventListener("click", handleQuickBtn);
  btn6.addEventListener("click", handleQuickBtn);
  btn7.addEventListener("click", handleQuickBtn);

  window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  let recognition = new SpeechRecognition();
  recognition.interimResults = false;
  recognition.lang = 'ko-KR';
  
  let makeNewTextContent = function() {
    p = document.createElement('p');
    document.querySelector('.body').appendChild(p);
  };
  
  let p = null;
  
  recognition.start();


  
  {% comment %} recognition.stop(); {% endcomment %}
  recognition.onstart = function() {
      makeNewTextContent(); // 음성 인식 시작시마다 새로운 문단을 추가한다.
    };
    recognition.onend = function() {
      recognition.start();
    };
    
    recognition.onresult = function(e) {
      let texts = Array.from(e.results)
      .map(results => results[0].transcript).join("");
      
      chatBody.innerHTML += "<div class='send'>" + texts + "</div>"

      let target = promise_search(texts)
          .then()
          .catch((error) => {
              console.log(error)
          })

      async function logItems(target) {
        var target_num = await target;
        make_body(target_num, texts)
      }    
      logItems(target)
  };
 
</script>


</body>
</html>

{% endblock %}