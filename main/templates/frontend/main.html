{% extends "base.html" %}

{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home!</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
   
    <script>
        function search(texts) {
            let search_key = texts
            let search_var = ''
            $.ajax({ 
                type: "GET", 
                url:'search/', 
                data : { 'search_key':search_key}, 
                dataType: 'json',
                async:false,
                success:function(data){ 
                    search_var = data['search_key']
                } ,
                error: function (error) {
                   // console.log(error);
                   search_var = '0'
               }
            }) 	
            return search_var
        }
    
        function promise_search(texts){
            return new Promise((resolve, reject) => {
    
                let target = search(texts)
                // 0.4초 안에 통신이 안되면, 에러 발생( promise 객체 이용 )
                setTimeout(() => {
                    if (target != undefined){
                        resolve(target)
                    } else {
                        reject('서버에 문제가 발생하여 인식하지 못했습니다.\n 다시 시도해주세요.')
                    }
                }, 400)
            })
        }
    </script>
   
</head>
<body>
<div class="main-frame row">
    <div class="ai-screen col-4">
        <div class="ai-screen-title d-flex">
            <p class="m-0">AI 일반 행원 김범수</p>
        </div>
        <div class="ai-screen-main">
        </div>
    </div>
    <div class="chatbot-screen col-8 d-flex justify-content-center align-items-center">
      <div class="container">
        <div class="body">
          <div class="receive">
            <div class="word">
            "좋은 아침입니다! AI 행원 ㅇㅇㅇ입니다.” <br><br>
            “무엇을 도와드릴까요?”
            </div>
            <div class="quick-container">
              <div><빠른 업무></div>
              <button class="quick_btn">1. 입금</button>
              <button class="quick_btn">2. 출금</button>
              <button class="quick_btn">3. 송금</button>
              <button class="quick_btn">4. 계좌조회</button>
              <button class="quick_btn">5. 계좌개설</button>
              <button class="quick_btn">6. 카드발급</button>
              <button class="quick_btn">7. 상품소개</button>
            </div>
            <div class="padding"></div>
          </div>
          <div class="receive">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loadTerms">모달</button>
          </div>
        </div>
        <div class="input_bar">
          <form class="form">
            <input type="text" class="form_input">
            <button class="btn">전송</button>
          </form>
        </div>
      </div>
    </div>
    <div class="modal fade" id="loadTerms" tabindex="-1" aria-labelledby="loadTermsLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="loadTerms">Modal title</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Lorem ipsum, dolor sit amet consectetur adipisicing elit. Rem minima qui possimus? Maiores neque rerum esse aperiam, temporibus labore voluptas ipsum voluptatum fuga quaerat aliquam assumenda vero deleniti quas! Velit!
            Harum inventore quidem nam excepturi odio provident sit placeat, voluptate aliquam mollitia fuga eveniet magni soluta eum, voluptates ullam voluptatum odit? Laborum dolor quo delectus exercitationem magni fugiat esse nam?
            Iusto sunt eos accusamus obcaecati totam ipsa rerum eaque quos, cumque voluptatibus! Odit possimus fugit ipsa quod earum enim adipisci optio doloribus nostrum saepe! Velit maxime alias placeat architecto. Ut.
            Reiciendis magnam praesentium aliquam inventore repellat facere at eveniet assumenda dolorem, dolore, necessitatibus nesciunt enim labore. Perspiciatis labore hic deleniti placeat quidem voluptatibus. Assumenda labore similique et, voluptatem dolorem perferendis.
            Nemo voluptatum blanditiis dolores, molestiae possimus accusamus. Illum, dolorem ab. Mollitia iusto ab voluptate incidunt praesentium, tenetur, ducimus magni temporibus cupiditate ex deserunt nobis ratione veniam id accusamus explicabo eligendi.
            Voluptatum unde aliquid sint tempora provident perferendis iusto ad quia consequatur ex? Quaerat corrupti tenetur dolorum ut deleniti dignissimos quos, exercitationem recusandae voluptates blanditiis quia magni in tempora distinctio! Quas!
            Explicabo est mollitia illo laboriosam neque. Nisi suscipit maxime quaerat dignissimos sequi blanditiis maiores molestias incidunt dolorum obcaecati, explicabo itaque inventore fuga, consequatur consequuntur beatae aspernatur, voluptatem officia numquam ex.
            Maiores totam dicta vero odio rerum? Perspiciatis saepe fugiat consectetur exercitationem repudiandae quos minus? Tempora exercitationem omnis saepe, incidunt quod temporibus animi pariatur nostrum iusto, asperiores reiciendis iure dignissimos ratione.
            Suscipit eum alias aspernatur ipsam, in magnam praesentium est fugiat nam sunt odit quia. Id iste, corporis labore cupiditate fugit dolore nulla blanditiis, laborum totam explicabo magni commodi aliquid quas.
            Rerum ipsum ullam quis id quidem sequi reiciendis aut nisi asperiores recusandae debitis, ipsa molestias neque, aspernatur, vero esse nesciunt aperiam nemo harum amet. Debitis eligendi doloremque modi adipisci nesciunt?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Save changes</button>
          </div>
        </div>
      </div>
    </div>
</div>

<script>

  const chatBody = document.querySelector(".body");

  window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  let recognition = new SpeechRecognition();
  recognition.interimResults = false;
  recognition.lang = 'ko-KR';
  
  let makeNewTextContent = function() {
    p = document.createElement('p');
    document.querySelector('.body').appendChild(p);
  };
  
  let p = null;
  
  recognition.start();
  recognition.onstart = function() {
      makeNewTextContent(); // 음성 인식 시작시마다 새로운 문단을 추가한다.
    };
    recognition.onend = function() {
      recognition.start();
    };
    
    recognition.onresult = function(e) {
      let texts = Array.from(e.results)
      .map(results => results[0].transcript).join("");
      
      
      chatBody.innerHTML += "<div class='send'>" + texts + "</div>"



      let target = promise_search(texts)
          .then()
          .catch((error) => {
              console.log(error)
          })

      

      async function logItems(target) {
        var target_num = await target;
        console.log(target_num)
        if (target_num == 2){
          // 입금
          chatBody.innerHTML += '<div class="receive">“입금을 도와드리겠습니다. 카드 또는 통장을 넣어주세요.”</div>'
          chatBody.innerHTML += '<div class="receive">“(로딩 10초)”</div>'
          setTimeout(() => 
          chatBody.innerHTML += '<div class="receive">“보내실 금액을 투입구에 넣어주세요.”</div>'
          , 2000);
          chatBody.innerHTML += '<div class="receive">“(로딩 10초)”</div>'
          setTimeout(() => 
          chatBody.innerHTML += '<div class="receive">"이용해 주셔서 감사합니다!"</div>',
          chatBody.innerHTML += '<div class="receive">“5초 후 자동으로 메인 화면으로 복귀합니다.”</div>'
          , 2000);
        } else if( target_num == 6){
          // 출금
          chatBody.innerHTML += '<div class="receive">“출금을 도와드리겠습니다. 카드 또는 통장을 넣어주세요.”</div>'
          chatBody.innerHTML += '<div class="receive">“(로딩 10초)”</div>'
          setTimeout(() => 
          chatBody.innerHTML += '<div class="receive">“출금하실 금액을 입력해주세요.”</div>'
          , 2000);
          chatBody.innerHTML += '<div class="receive">“(로딩 10초)”</div>'
          setTimeout(() => 
          chatBody.innerHTML += '<div class="receive">“이용해 주셔서 감사합니다!“</div>',
          chatBody.innerHTML += '<div class="receive">“5초 후 자동으로 메인 화면으로 복귀합니다.”</div>'
          , 2000);
        } else if( target_num == 1){
          // 송금
          chatBody.innerHTML += '<div class="receive">“송금을 도와드리겠습니다. 송금 유형을 선택해주세요.”</div>'
          chatBody.innerHTML += '<div class="receive">“카드 또는 통장을 넣어주세요.”</div>'
          chatBody.innerHTML += '<div class="receive">“(로딩 10초)”</div>'
          setTimeout(() => 
          chatBody.innerHTML += '<div class="receive">“받는 사람의 계좌번호를 입력해 주세요.”</div>'
          , 2000);
          chatBody.innerHTML += '<div class="receive">“(로딩 10초)”</div>'
          setTimeout(() => 
          chatBody.innerHTML += '<div class="receive">“이용해 주셔서 감사합니다!“</div>',
          chatBody.innerHTML += '<div class="receive">“5초 후 자동으로 메인 화면으로 복귀합니다.”</div>'
          , 2000);
        } else if( target_num == 3){
          // 조회
          chatBody.innerHTML += '<div class="receive">“계좌조회를 도와드리겠습니다. 카드 또는 통장을 넣어주세요.”</div>'
          chatBody.innerHTML += '<div class="receive">“비밀번호를 입력해주세요.”</div>'
          chatBody.innerHTML += '<div class="receive">“(로딩 10초)”</div>'
          setTimeout(() => 
          chatBody.innerHTML += '<div class="receive">“이용해 주셔서 감사합니다!“</div>',
          chatBody.innerHTML += '<div class="receive">“5초 후 자동으로 메인 화면으로 복귀합니다.”</div>'
          , 2000);
        } else if( target_num == 4){
          // 개설
          chatBody.innerHTML += '<div class="receive">“계좌개설을 도와드리겠습니다. 약관을 읽고 동의 버튼을 눌러주세요”</div>'
          chatBody.innerHTML += '<div class="receive">“약관에 동의해 주세요.”</div>'
          chatBody.innerHTML += '<div class="receive">“(로딩 10초)”</div>'
          chatBody.innerHTML += '<div class="receive">“신분증을 촬영해 주세요.”</div>'
          setTimeout(() => 
          chatBody.innerHTML += '<div class="receive">“이용해 주셔서 감사합니다!“</div>',
          chatBody.innerHTML += '<div class="receive">“5초 후 자동으로 메인 화면으로 복귀합니다.”</div>'
          , 2000);
        } else if( target_num == 5){
          // 발급
          chatBody.innerHTML += '<div class="receive">“카드발급을 도와드리겠습니다. 약관을 읽고 동의 버튼을 눌러주세요”</div>'
          chatBody.innerHTML += '<div class="receive">“약관에 동의해 주세요.”</div>'
          chatBody.innerHTML += '<div class="receive">“(로딩 10초)”</div>'
          chatBody.innerHTML += '<div class="receive">“신분증을 촬영해 주세요.”</div>'
          setTimeout(() => 
          chatBody.innerHTML += '<div class="receive">“이용해 주셔서 감사합니다!“</div>',
          chatBody.innerHTML += '<div class="receive">“5초 후 자동으로 메인 화면으로 복귀합니다.”</div>'
          , 2000);
        } else if ( target_num == 0){
          // 발급
          chatBody.innerHTML += '<div class="receive">“다시 말씀해주세요.”</div>'

        } else if ( target_num == 7){
          // 발급
          if (texts == '안녕하세요'){
            chatBody.innerHTML += '<div class="receive">"안녕하세요.”</div>'

          }
        } 



      }    

      logItems(target)





      
  };

  document.body.style.overflow = "hidden"

  const chatForm = document.querySelector(".form");
  const chatInput = document.querySelector(".form_input");

  function handleChatSubmit(event) {

    function checkValue(inputValue) {
      const list = {
        "송금" : true,
        "입금" : true,
      }
      if (list[inputValue] === undefined)
        return false
      return true
    }

    event.preventDefault();
    const inputValue = chatInput.value;
    chatBody.innerHTML += "<div class='send'>" + inputValue + "</div>"
    chatInput.value = "";
    if (checkValue(inputValue) === false)
      chatBody.innerHTML += '<div class="receive">“죄송합니다. 고객님, 다시 한 번 말씀해주시겠습니까?"</div>'
  }

  chatForm.addEventListener("submit", handleChatSubmit);
  
</script>

<style scoped>

    .main-frame {
        height: 56rem;
    }

    .ai-screen-title {
        background-color: #f8a70c;
        height: 10%;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
    }

    .ai-screen-main {
        background-color: black;
        height: 90%;
    }
    
    .chatbot-screen {
      background-color : #F0F0F0;
    }

    .body {
      height : 95%;
    }

    .input_bar {
      height : 5%;
      width : 100%;
      background-color : #FFFFFF;
    }

    .form_input {
      width : 85%;
      height : 5%;
      font-size : 20px;
      border : transparent;
    }

    .btn {
      padding : 0px;
      width : 10%;
    }

    .container {
      padding : 0px;
      width: 70%;
      height : 100%;
      background-color: #9bbbd4;
    }

    .send {
      border-radius : 1em;
      background-color : #FFFFFF;
      margin-top : 10px;
      margin-right : 10px;
      padding-right: 15px;
      padding-left : 15px;
      width : 40%;
      margin-left: auto;
      white-space: normal;
      word-wrap: break-word;
    }

    .receive {
      border-radius : 1em;
      background-color : #FFFFFF;
      margin-top : 10px;
      margin-right : 10px;
      margin-left : 10px;
      padding-right: 15px;
      padding-left : 15px;
      width : 40%;
      height : auto;
      margin-right: auto;
      white-space: normal;
      word-wrap: break-word;
    }

    .quick-container {
      border : 2px solid #F0F0F0;
      border-radius : 0.5em;
      text-align : center;
      padding-bottom : 10px;
      margin : 10px;
    }

    .quick_btn {
      width : 97%;
      border-radius : 0.5em;
      border : transparent;
      margin-top : 5px;
    }

    .word {
      padding-top : 15px;
      margin-bottom : 15px;
    }

    .padding {
      padding : 5px;
    }

</style>
</body>
</html>

{% endblock %}