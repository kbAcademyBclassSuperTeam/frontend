{% extends "base.html" %}

{% block content %}


<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <title>Home!</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script>



    // tts 시작
    var voices = [];

    function setVoiceList() {
        voices = window.speechSynthesis.getVoices();
    }

    if (window.speechSynthesis.onvoiceschanged !== undefined) {
        window.speechSynthesis.onvoiceschanged = setVoiceList;

    }

    function speech(txt, check=false) {
      
        if(!window.speechSynthesis) {
            alert("음성 재생을 지원하지 않는 브라우저입니다. 크롬, 파이어폭스 등의 최신 브라우저를 이용하세요");
        return;
        }

    var lang = 'ko-KR';
    var utterThis = new SpeechSynthesisUtterance(txt);
    
    utterThis.onend = function (event) {
        console.log('end');
    };
    utterThis.onerror = function(event) {
        console.log('error', event);
    };

    var voiceFound = false;
    for(var i = 0; i < voices.length ; i++) { // 20
        if(voices[i].lang.indexOf(lang) >= 0 || voices[i].lang.indexOf(lang.replace('-', '_')) >= 0) {
            utterThis.voice = voices[i];
            voiceFound = true;
        }
    }

    if(!voiceFound) {
        alert('voice not found');
        return;
    }
    
    utterThis.lang = lang;
    utterThis.pitch = 1;
    utterThis.rate = 1; //속도

    window.speechSynthesis.speak(utterThis);

    utterThis.onend = function(event){
      if (check){

        recognition.start();
      }
    }


    }

    window.addEventListener("load", function(e) {
      setTimeout(() => {
      var t = e.target;
      var input = t.previousElementSibling;
      var speacklist=[
      "좋은 하루입니다! AI 행원 루나스입니다.",
        "무엇을 도와드릴까요?",
        "입금, 출금, 송금, 계좌조회, 계좌개설, 카드발급이 가능합니다.",
        ];

      for(var j=0;j<1;j++) {
          console.log(speacklist[j]);
          speech(speacklist[j], true);
      }
      return;
    }, 1000);
    });

    // tts 끝
      function search(texts) {
          let search_key = texts
          let search_var = ''
          $.ajax({ 
              type: "GET", 
              url:'search/', 
              data : { 'search_key':search_key}, 
              dataType: 'json',
              async:false,
              success:function(data){ 
                  search_var = data['search_key']
              } ,
              error: function (error) {
                  // console.log(error);
                search_var = '0'
            }
          }) 	
          return search_var
      } 
  
      function promise_search(texts){
          return new Promise((resolve, reject) => {
              let target = search(texts)
              // 0.4초 안에 통신이 안되면, 에러 발생( promise 객체 이용 )
              setTimeout(() => {
                  if (target != undefined){
                      resolve(target)
                  } else {
                      reject('서버에 문제가 발생하여 인식하지 못했습니다.\n 다시 시도해주세요.')
                  }
              }, 400)
          })
      }

      function make_body(answer, texts, target_num){

        
        const objBody = document.querySelector(".body"); 
        
        function addChat(sentence, check=false) {
          chatBody.innerHTML += '<div class="receive">' + sentence + '</div>'
          objBody.scrollTop = objBody.scrollHeight;
          speech(sentence, check);
        }
        
        function addChatNoTts(sentence) {
          chatBody.innerHTML += '<div class="receive">' + sentence + '</div>'
          objBody.scrollTop = objBody.scrollHeight;
        }
        function printAndTTS(senlist, check = false) {
          var delaySec = 3000;
          for(let j =0; j<senlist.length ; j++) {
            var anonFunc = function(j) {
              setTimeout(() => {
                if(senlist[j]=="...") addChatNoTts(senlist[j]);
                else if (senlist[j] == "모달-금액"){
                  $('#amountModal').modal('show');
                }else if (senlist[j] == "모달-비밀번호"){
                  $('#passwdModal').modal('show');
                }
                else if (senlist[j]!="") addChat(senlist[j], check);
                else window.location.href = '/main/';   
              }, j*delaySec)
            }
            anonFunc(j);
          }
        }
        if(texts == 'button'){
          recognition.stop()  
          printAndTTS(search(answer), false)

          return
        }

        // 타겟 넘버 별 TTS 시작 부분  
        if (texts == "안녕하세요"){
          addChat(answer, true)
        }else{
          if (answer == "다시 말씀해주세요"){
            printAndTTS(answer, true)
            return

          }
          printAndTTS(answer)
        }
        // TTS end
        
      }


  </script>

</head>
<body>
<div class="main-frame row">
    <div class="ai-screen col-4">
        <div class="ai-screen-title d-flex">
            <p class="m-0">AI 일반 행원 김범수</p>
        </div>
        <div class="ai-screen-main">
        </div>
    </div>
    <div class="chatbot-screen col-8 d-flex justify-content-center align-items-center">
      <div class="container">
        <div class="body">
          <div class="receive">
            <div class="word">
            "좋은 하루입니다! AI 행원 루나스입니다.” <br><br>
            “무엇을 도와드릴까요?”
            </div>
            <div class="quick-container">
              <div><빠른 업무></div>
              <button class="quick_btn" id="btn_2" value="2">1. 입금</button>
              <button class="quick_btn" id="btn_6" value="6">2. 출금</button>
              <button class="quick_btn" id="btn_1" value="1">3. 송금</button>
              <button class="quick_btn" id="btn_3" value="3">4. 계좌조회</button>
              <button class="quick_btn" id="btn_4" value="4">5. 계좌개설</button>
              <button class="quick_btn" id="btn_5" value="5">6. 카드발급</button>
              <button class="quick_btn" id="btn_7" value="7">7. 상품소개</button>
            </div>
            <div class="padding"></div>
          </div>
          <div class="receive">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#passwdModal">모달</button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#amountModal">모달</button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#balanceModal">모달</button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#termsModal">모달</button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#cardModal">모달</button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#issueModal">모달</button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addressModal">모달</button>
          </div>
          {% comment %} <div class="receive">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loadTerms">모달</button>
          </div> {% endcomment %}
        </div>
        <div class="input_bar">
          <form class="form">
            <input type="text" class="form_input">
            <button class="btn">전송</button>
          </form>
        </div>
      </div>
    </div>
    <!--비밀번호 모달-->
    <div class="modal fade" id="passwdModal" tabindex="-1" aria-labelledby="passwdModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">비밀번호를 입력해주세요.</h5>
          </div>
          <div class="form-group formCss">
              <input class="form-control passwdInput" id="passwdModalInput" type="password" value="" readonly/>
            <div class="btnGroup">
              <button class="btn btn-primary passwdBtn" id="passwdBtn_1" value="1" onclick="put_num(1 ,'password')">1</button>
              <button class="btn btn-primary passwdBtn" id="passwdBtn_2" value="2" onclick="put_num(2 ,'password')">2</button>
              <button class="btn btn-primary passwdBtn" id="passwdBtn_3" value="3" onclick="put_num(3 ,'password')">3</button>
              <button class="btn btn-primary passwdBtn" id="passwdBtn_4" value="4" onclick="put_num(4 ,'password')">4</button>
              <button class="btn btn-primary passwdBtn" id="passwdBtn_5" value="5" onclick="put_num(5 ,'password')">5</button>
              <button class="btn btn-primary passwdBtn" id="passwdBtn_6" value="6" onclick="put_num(6 ,'password')">6</button>
              <button class="btn btn-primary passwdBtn" id="passwdBtn_7" value="7" onclick="put_num(7 ,'password')">7</button>
              <button class="btn btn-primary passwdBtn" id="passwdBtn_8" value="8" onclick="put_num(8 ,'password')">8</button>
              <button class="btn btn-primary passwdBtn" id="passwdBtn_9" value="9" onclick="put_num(9 ,'password')">9</button>
              <button class="btn btn-primary passwdBtn2" id="passwdBtn_reset" value="r" onclick="reset('password')">초기화</button>
              <button class="btn btn-primary passwdBtn" id="passwdBtn_0" value="0" onclick="put_num(0, 'password')">0</button>
              <button class="btn btn-primary passwdBtn2" id="passwdBtn_clear" value="c" onclick="clearOne('password')">지움</button>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary footerBtn" id="passwordModalOK">확인</button>
            <button type="button" class="btn btn-secondary footerBtn" id="passwordModalNO">취소</button>
          </div>
        </div>
      </div>
    </div>
    <!--금액 모달-->
    <div class="modal fade" id="amountModal" tabindex="-1" aria-labelledby="amountModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" >출금하실 금액을 입력해주세요.</h5>
          </div>
          <div class="form-group formCss">
            <input class="form-control passwdInput" id="amountModalInput" value="" readonly/>
            <div class="btnGroup">
              <button class="btn btn-primary passwdBtn" id="amountBtn_1" value="1" onclick="put_num(1, 'amount')">1</button>
              <button class="btn btn-primary passwdBtn" id="amountBtn_2" value="2" onclick="put_num(2, 'amount')">2</button>
              <button class="btn btn-primary passwdBtn" id="amountBtn_3" value="3" onclick="put_num(3, 'amount')">3</button>
              <button class="btn btn-primary passwdBtn" id="amountBtn_4" value="4" onclick="put_num(4, 'amount')">4</button>
              <button class="btn btn-primary passwdBtn" id="amountBtn_5" value="5" onclick="put_num(5, 'amount')">5</button>
              <button class="btn btn-primary passwdBtn" id="amountBtn_6" value="6" onclick="put_num(6, 'amount')">6</button>
              <button class="btn btn-primary passwdBtn" id="amountBtn_7" value="7" onclick="put_num(7, 'amount')">7</button>
              <button class="btn btn-primary passwdBtn" id="amountBtn_8" value="8" onclick="put_num(8, 'amount')">8</button>
              <button class="btn btn-primary passwdBtn" id="amountBtn_9" value="9" onclick="put_num(9, 'amount')">9</button>
              <button class="btn btn-primary passwdBtn2" id="amountBtn_reset" value="r" onclick="reset('amount')">초기화</button>
              <button class="btn btn-primary passwdBtn" id="amountBtn_0" value="0" onclick="put_num(0, 'amount')">0</button>
              <button class="btn btn-primary passwdBtn2" id="amountBtn_clear" value="c" onclick="clearOne('amount')">지움</button>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary footerBtn" id="amountModalOK">확인</button>
            <button type="button" class="btn btn-secondary footerBtn" id="amountModalNO">취소</button>
          </div>
        </div>
      </div>
    </div>
    <!--계좌조회 모달-->
    <div class="modal fade" id="balanceModal" tabindex="-1" aria-labelledby="balanceModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">계좌를 조회합니다.</h5>
            <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
          </div>
          <div class="form-group">
            <table class="balanceTable">
              <tr>
                <td class="head">계좌이름 : </td>
                <td>KB나라사랑우대통장</td>
              </tr>
              <tr>
                <td class="head">계좌번호 : </td>
                <td>123456-01-123456</td>
              </tr>
              <tr>
                <td class="head">잔액 : </td>
                <td>800,000,000 원</td>
              </tr>
              <tr>
                <td class="head">출금가능금액 : </td>
                <td>800,000,000 원</td>
              </tr>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary footerBtn" id="balanceModalSEND">송금</button>
            <button type="button" class="btn btn-secondary footerBtn" id="balanceModalWithdraw">출금</button>
            <button type="button" class="btn btn-primary footerBtn" id="balanceModalOK">확인</button>
          </div>
        </div>
      </div>
    </div>
    <!--약관동의 모달-->
    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">약관을 읽고 동의해주세요.</h5>
            <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
          </div>
          <div class="terms" id="terms">
            <div class="termsContent">
              <embed src="{% static 'text/terms.txt' %}">
            </div>
          </div>
          <div class="modal-footer">
            <div class="termsCheckbox">
              <input type="checkbox" id="termsCheckbox"> 약관을 충분히 이해하였으며 동의합니다. </input>
            </div>
            <button type="button" class="btn btn-primary footerBtn" id="termsModalOK" disabled="true">확인</button>
            <button type="button" class="btn btn-secondary footerBtn" id="termsModalNO">취소</button>
          </div>
        </div>
      </div>
    </div>
    <!--카드추천 모달-->
    <div class="modal fade" id="cardModal" tabindex="-1" aria-labelledby="cardModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">발급을 원하시는 카드를 선택해주세요.</h5>
          </div>
          <div class="cardList">
            <div class="cardContent" id="cardContent">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary footerBtn" id="cardModalOK" disabled="true">확인</button>
            <button type="button" class="btn btn-secondary footerBtn" id="cardModalNO">취소</button>
          </div>
        </div>
      </div>
    </div>
    <!--카드발급 모달-->
    <div class="modal fade" id="issueModal" tabindex="-1" aria-labelledby="issueModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-ms">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">카드를 발급하시겠습니까?</h5>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary footerBtn" id="issueModalOK">확인</button>
            <button type="button" class="btn btn-secondary footerBtn" id="issueModalNO">취소</button>
          </div>
        </div>
      </div>
    </div>
    <!--배송지입력 모달-->
    <div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-ms">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">카드를 배송받을 주소를 입력해주세요.</h5>
          </div>
          <div>
            <div class="addressContent" id="addressContent">
              <input type="text" class="addressInput" id="addressInput">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary footerBtn" id="addressModalOK" disabled="true">확인</button>
            <button type="button" class="btn btn-secondary footerBtn" id="addressModalNO">취소</button>
          </div>
        </div>
      </div>
    </div>
</div>

<script>

  // 비밀번호 모달 함수
  amount = ""
  password = ""
  passwordTries = 0;
  localStorage.setItem("password", "1234");

  function put_num(value, modal) {
    if (modal == "password")
    {
      var input = document.querySelector("#passwdModalInput")
      input.value += value;
      password = input.value;
    }
    else if (modal == "amount")
    {
      var input = document.querySelector("#amountModalInput")
      if (input.value === "" && value === 0)
        return ;
      input.value = input.value.split(',').join("") + value;
      input.value = input.value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      amount = input.value
    }
  }

  function reset(modal) {
    if (modal == "password")
    {
      var input = document.querySelector("#passwdModalInput")
      input.value = ""
      password = input.value;
    }
    else if (modal == "amount")
    {
      var input = document.querySelector("#amountModalInput")
      input.value = ""
      amount = input.value
    }
  }

  function clearOne(modal) {
    if (modal == "password")
    {
      var input = document.querySelector("#passwdModalInput")
      if (input.value != "")
        input.value = input.value.slice(0, -1);
      password = input.value
    }
    else if (modal == "amount")
    {
      var input = document.querySelector("#amountModalInput")
      if (input.value != "")
      input.value = input.value.split(',').join("")
      input.value = input.value.slice(0, -1);
      input.value = input.value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      amount = input.value
    }
  }

  // 약관동의 모달 함수

  const termsModalCheckbox = document.querySelector('#termsCheckbox')
  const termsModalOK = document.querySelector('#termsModalOK')

  function handleCheckbox() {
    termsModalCheckbox.checked === false ? termsModalOK.disabled = true : termsModalOK.disabled = false
  }

  termsModalCheckbox.addEventListener("click", handleCheckbox)

  // 카드발급 모달 함수

  card = [
    { "tag" : "<div class='cardUnit'><img class='cardImg' src='/static/img/04285_img.png' alt='cheongchun'><div><h3><input type='checkbox' name='card' onclick='checkOnlyOne(this)' id='card_1'>청춘대로 톡톡카드</h3><div>Simple하게 즐기자!</div><div>혜택 톡톡! 스타벅스 50% 청구할인 버거/패스트푸드 20% 청구할인 간편결제 Pay 10% 청구할인</div></div></div>",
      "content" : ""},
      { "tag" : "<div class='cardUnit'><img class='cardImg' src='/static/img/02065_img.png' alt='cheongchun'><div><h3><input type='checkbox' name='card' onclick='checkOnlyOne(this)' id='card_2'>청춘대로 톡톡카드</h3><div>Simple하게 즐기자!</div><div>혜택 톡톡! 스타벅스 50% 청구할인 버거/패스트푸드 20% 청구할인 간편결제 Pay 10% 청구할인</div></div></div>",
      "content" : ""},
      { "tag" : "<div class='cardUnit'><img class='cardImg' src='/static/img/09157_img.png' alt='cheongchun'><div><h3><input type='checkbox' name='card' onclick='checkOnlyOne(this)' id='card_3'>청춘대로 톡톡카드</h3><div>Simple하게 즐기자!</div><div>혜택 톡톡! 스타벅스 50% 청구할인 버거/패스트푸드 20% 청구할인 간편결제 Pay 10% 청구할인</div></div></div>",
      "content" : ""},
      { "tag" : "<div class='cardUnit'><img class='cardImg' src='/static/img/09174_img.png' alt='cheongchun'><div><h3><input type='checkbox' name='card' onclick='checkOnlyOne(this)' id='card_4'>청춘대로 톡톡카드</h3><div>Simple하게 즐기자!</div><div>혜택 톡톡! 스타벅스 50% 청구할인 버거/패스트푸드 20% 청구할인 간편결제 Pay 10% 청구할인</div></div></div>",
      "content" : ""},
      { "tag" : "<div class='cardUnit'><img class='cardImg' src='/static/img/09251_img.png' alt='cheongchun'><div><h3><input type='checkbox' name='card' onclick='checkOnlyOne(this)' id='card_5'>청춘대로 톡톡카드</h3><div>Simple하게 즐기자!</div><div>혜택 톡톡! 스타벅스 50% 청구할인 버거/패스트푸드 20% 청구할인 간편결제 Pay 10% 청구할인</div></div></div>",
      "content" : ""},
      { "tag" : "<div class='cardUnit'><img class='cardImg' src='/static/img/09644_img.png' alt='cheongchun'><div><h3><input type='checkbox' name='card' onclick='checkOnlyOne(this)' id='card_6'>청춘대로 톡톡카드</h3><div>Simple하게 즐기자!</div><div>혜택 톡톡! 스타벅스 50% 청구할인 버거/패스트푸드 20% 청구할인 간편결제 Pay 10% 청구할인</div></div></div>",
      "content" : ""},
  ]
  const cardContent = document.querySelector('#cardContent')
  cardContent.innerHTML += card[0].tag
  cardContent.innerHTML += card[1].tag
  cardContent.innerHTML += card[2].tag
  cardContent.innerHTML += card[3].tag
  cardContent.innerHTML += card[4].tag
  cardContent.innerHTML += card[5].tag

  function checkOnlyOne(element) {
  
  const checkboxes = document.getElementsByName("card");
  const cardModalOK = document.querySelector("#cardModalOK")

  if (element.checked === false)
  {
    element.checked = false;
    cardModalOK.disabled = true;
    return;
  }
  
  checkboxes.forEach((cb) => {
    cb.checked = false;
  })
  
  element.checked = true;
  cardModalOK.disabled = false;
}

// 배송지입력 모달 함수

const addressInput = document.querySelector("#addressInput")
const addressModalOK = document.querySelector("#addressModalOK")

function onInput() {
  if (addressInput.value !== "")
    addressModalOK.disabled = false
  else
    addressModalOK.disabled = true
}

addressInput.addEventListener("input", onInput)


  document.body.style.overflow = "hidden"

  const chatForm = document.querySelector(".form");
  const chatInput = document.querySelector(".form_input");
  const chatBody = document.querySelector(".body");
  const btn1 = document.querySelector("#btn_1");
  const btn2 = document.querySelector("#btn_2");
  const btn3 = document.querySelector("#btn_3");
  const btn4 = document.querySelector("#btn_4");
  const btn5 = document.querySelector("#btn_5");
  const btn6 = document.querySelector("#btn_6");
  const btn7 = document.querySelector("#btn_7");

  chatForm.addEventListener("submit", handleChatSubmit);
  btn1.addEventListener("click", handleQuickBtn);
  btn2.addEventListener("click", handleQuickBtn);
  btn3.addEventListener("click", handleQuickBtn);
  btn4.addEventListener("click", handleQuickBtn);
  btn5.addEventListener("click", handleQuickBtn);
  btn6.addEventListener("click", handleQuickBtn);
  btn7.addEventListener("click", handleQuickBtn);

  function handleQuickBtn(event) {
    list = {
      "1" : "송금을 선택하셨습니다.",
      "2" : "입금을 선택하셨습니다.",
      "3" : "계좌조회을 선택하셨습니다.",
      "4" : "계좌개설을 선택하셨습니다.",
      "5" : "카드발급을 선택하셨습니다.",
      "6" : "출금을 선택하셨습니다.",
      "7" : "상품소개을 선택하셨습니다.",
    }

    const objBody = document.querySelector(".body");
    const target = event.target.value
    const list_num = list[target]

    chatBody.innerHTML += "<div class='send'>" + list_num + "</div>"
    objBody.scrollTop = objBody.scrollHeight;
    make_body(list_num, 'button');
  }

  function handleChatSubmit(event) {

    const objBody = document.querySelector(".body");
    event.preventDefault();
    if (chatInput.value == "")
      return;
    const inputValue = chatInput.value;

    chatBody.innerHTML += "<div class='send'>" + inputValue + "</div>"
    chatInput.value = "";

    objBody.scrollTop = objBody.scrollHeight;
    let target = promise_search(inputValue)
          .then()
          .catch((error) => {
              console.log(error)
          })

      async function logItems(target) {
        var target_num = await target;
        make_body(target_num, inputValue)
      }    
      logItems(target)
  }






  window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  let recognition = new SpeechRecognition();
  recognition.interimResults = false;
  recognition.lang = 'ko-KR';
  
  let makeNewTextContent = function() {
    p = document.createElement('p');
    document.querySelector('.body').appendChild(p);
  };
  
  let p = null;
  



  
  {% comment %} recognition.stop(); {% endcomment %}
  recognition.onstart = function() {
      makeNewTextContent(); // 음성 인식 시작시마다 새로운 문단을 추가한다.
    };
    recognition.onend = function() {
      recognition.stop();
    };

    {% comment %} recognition.onspeechend = function() {
      console.log('Speech has stopped being detected');
      recognition.stop();
    } {% endcomment %}
    
    recognition.onresult = function(e) {
      console.log(e)
      let texts = Array.from(e.results)
      .map(results => results[0].transcript).join("");
      
      chatBody.innerHTML += "<div class='send'>" + texts + "</div>"

      let target = promise_search(texts)
          .then()
          .catch((error) => {
              console.log(error)
          })

      async function logItems(target) {
        var answer_list = await target;
        console.log(answer_list)
        var num = answer_list.slice(0, 1)
        answer_list = answer_list.slice(1,)
        make_body(answer_list, texts, num)
      }    
      logItems(target)
  };
  $("#restart").click(function () {
    recognition.start();
  })
  
  $('#stoptts').click(function () {
    window.speechSynthesis.cancel();
    console.log(window.speechSynthesis);
  })

</script>
</body>
</html>

{% endblock %}